<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Estaci√≥n Meteorol√≥gica</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body{display:flex;flex-direction:column;align-items:center;min-height:100vh;position:relative;transition:background-color 1s;background:linear-gradient(135deg,#202c3b,#2d3e50);font-family:'Orbitron',sans-serif}
    .card{background:rgba(255,255,255,0.05);backdrop-filter:blur(8px);border-radius:16px;padding:16px;box-shadow:0 12px 40px rgba(0,0,0,.25)}
    .data-box{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.05);padding:12px;border-radius:12px;margin:6px 0}
    .label{color:#a6b3c9}
    .value{font-size:22px;color:#78d0ff;font-weight:700}
  </style>
  <!-- opcional: <meta name="rail-api-base" content="https://tu-app.up.railway.app"> -->
</head>
<body class="text-slate-100 p-4 w-full max-w-5xl">

  <h1 class="text-3xl font-extrabold mb-4 text-center">Estaci√≥n Meteorol√≥gica en tiempo real cada minuto</h1>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full">
    <!-- Tarjeta: Lluvia acumulada anual -->
    <div class="card">
      <div class="text-slate-300 text-sm">Lluvia acumulada</div>
      <div id="total-lluvia" class="text-4xl font-extrabold text-cyan-300 mt-1">--</div>
      <div id="total-lluvia-rango" class="text-slate-400 text-xs mt-1">(a√±o actual)</div>
    </div>

    <!-- Tarjeta: Lecturas actuales -->
    <div class="card">
      <div class="data-box"><p class="label">üå°Ô∏è Temperatura</p><p class="value" id="temp">--</p></div>
      <div class="data-box"><p class="label">üíß Humedad</p><p class="value" id="hum">--</p></div>
      <div class="data-box"><p class="label">üçÉ Viento</p><p class="value" id="wind">--</p></div>
      <div class="data-box"><p class="label">üß≠ Direcci√≥n</p><p class="value" id="dir">--</p></div>
      <div class="data-box"><p class="label">üåßÔ∏è Lluvia</p><p class="value" id="rainfall">--</p></div>
    </div>

    <!-- Tarjeta: Lluvia mensual -->
    <div class="card">
      <h2 class="text-xl font-bold mb-2">üìÖ Lluvia mensual (WU)</h2>
      <input id="mes-selector" type="month" class="text-black rounded px-2 py-1" />
      <button id="btn-mes" class="ml-2 px-3 py-1 rounded bg-cyan-500 text-black font-semibold">Calcular</button>
      <span id="spinner-mes" class="ml-2 hidden">‚è≥</span>
      <div id="resultado-mes" class="mt-2 text-sm text-slate-300"></div>
      <canvas id="grafico-lluvia" width="400" height="200" class="mt-3"></canvas>
    </div>
  </div>

  <script>
    /* ====== CONFIG API BASE ====== */
    (function initApiBase(){
      const meta = document.querySelector('meta[name="rail-api-base"]');
      const fromMeta = meta && meta.getAttribute('content') || '';
      window.RAIL_API_BASE =
        (fromMeta && fromMeta.trim()) ||
        (window.RAIL_API_BASE && String(window.RAIL_API_BASE)) ||
        (location.origin && String(location.origin)) ||
        'https://produccion-alemana-d2b4.up.railway.app';
    })();

    const STATION_ID = 'IALFAR32';
    const FETCH_OPTS = { cache: 'no-store', credentials: 'include' };

    /* ====== Observaci√≥n actual ====== */
    async function fetchWeatherData() {
      try {
        const url = `${window.RAIL_API_BASE}/api/weather/current?stationId=${encodeURIComponent(STATION_ID)}`;
        const response = await fetch(url, FETCH_OPTS);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const ct = (response.headers.get('content-type') || '').toLowerCase();
        const text = await response.text();
        if (!ct.includes('application/json')) throw new Error('No JSON');
        const data = JSON.parse(text);

        const obs = data?.observations?.[0] || data?.data?.[0] || {};
        const m = obs.metric || obs.imperial || {};
        document.getElementById('temp').textContent    = m.temp != null ? `${m.temp} ¬∞C` : '--';
        document.getElementById('hum').textContent     = obs.humidity != null ? `${obs.humidity} %` : '--';
        document.getElementById('wind').textContent    = m.windSpeed != null ? `${m.windSpeed} km/h` : '--';
        document.getElementById('dir').textContent     = obs.winddir != null ? `${obs.winddir}¬∞` : '--';
        document.getElementById('rainfall').textContent= m.precipTotal != null ? `${m.precipTotal} mm` : '0 mm';
      } catch(e){ console.error(e); }
    }

    /* ====== YTD lluvia (1 enero -> HOY) ====== */
    (async function cargarTotalLluviaAnual(){
      const el = document.getElementById('total-lluvia');
      const rangoEl = document.getElementById('total-lluvia-rango');
      try {
        const r = await fetch(`${window.RAIL_API_BASE}/api/lluvia/total/year`, { credentials: 'include', cache: 'no-store' });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const data = await r.json();
        const mm = Number(data?.total_mm ?? 0);
        el.textContent = (Number.isFinite(mm) ? mm : 0).toFixed(1) + ' mm';
        rangoEl.textContent = (data?.desde && data?.hasta) ? `(${data.year}: ${data.desde} ‚Üí ${data.hasta})` : '(a√±o actual)';
      } catch(e){
        console.error(e);
        el.textContent = '‚Äî';
        rangoEl.textContent = '(sin datos)';
      }
    })();

    /* ====== Lluvia mensual (selector) ====== */
    function mostrarLluviaAcumuladaPorMes() {
      const stationId = STATION_ID;
      const mesInput = document.getElementById('mes-selector').value;
      const resultado = document.getElementById('resultado-mes');
      const spinner = document.getElementById('spinner-mes');
      const canvas = document.getElementById('grafico-lluvia');
      const ctx = canvas.getContext('2d');

      if (!mesInput) { resultado.textContent = "‚ö†Ô∏è Selecciona un mes v√°lido."; return; }

      const [year, month] = mesInput.split("-");
      const startDate = `${year}${month}01`;
      const endDate = `${year}${month}${new Date(year, month, 0).getDate().toString().padStart(2, '0')}`;

      spinner.classList.remove('hidden');
      fetch(`${window.RAIL_API_BASE}/api/weather/history?stationId=${encodeURIComponent(stationId)}&startDate=${encodeURIComponent(startDate)}&endDate=${encodeURIComponent(endDate)}`, FETCH_OPTS)
        .then(res => { if (!res.ok) throw new Error(`HTTP ${res.status}`); return res.json(); })
        .then(data => {
          const arr = data?.observations || data?.data || [];
          const dias = arr.map(day => {
            const fecha = new Date(day.obsTimeLocal || day.obsTimeUtc || day.date || day.day);
            return Number.isFinite(fecha.getTime()) ? fecha.getDate() : null;
          });
          const lluviaDiaria = arr.map(day => (day.metric?.precipTotal ?? day.precipTotal ?? 0) || 0);
          const total = lluviaDiaria.reduce((a, b) => a + (Number(b) || 0), 0);

          resultado.textContent = `üåßÔ∏è Lluvia total en ${month}/${year}: ${total.toFixed(2)} mm`;

          if (window.__chart__) window.__chart__.destroy();
          window.__chart__ = new Chart(ctx, {
            type: 'bar',
            data: { labels: dias, datasets: [{ label: 'Lluvia diaria (mm)', data: lluviaDiaria }] },
            options: { responsive: true, plugins: { legend: { display: true }, title: { display: true, text: `Lluvia diaria - ${month}/${year}` } } }
          });
        })
        .catch(err => { console.error(err); resultado.textContent = "No se pudieron obtener datos."; })
        .finally(() => spinner.classList.add('hidden'));
    }
    document.getElementById("btn-mes").addEventListener("click", mostrarLluviaAcumuladaPorMes);

    /* ====== Ping de sesi√≥n ====== */
    setInterval(async () => {
      try {
        const res = await fetch(`${window.RAIL_API_BASE}/verificar-sesion`, FETCH_OPTS);
        if (res.status === 401) { location.href = '/login.html?error=sesion'; return; }
        const ct = (res.headers.get('content-type') || '').toLowerCase();
        const text = await res.text();
        if (!text || !ct.includes('application/json')) return;
        const data = JSON.parse(text);
        if (data && data.activo === false) location.href = '/login.html?error=sesion';
      } catch {}
    }, 30000);

    /* ====== Primeras cargas ====== */
    fetchWeatherData();
    setInterval(fetchWeatherData, 60_000);
  </script>
</body>
</html>
































































































































































